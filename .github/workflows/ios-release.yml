name: iOS Release

on:
  push:
    tags:
      - 'ios-v*.*.*'  # Trigger on tags like ios-v1.0.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string
      build_number:
        description: 'Build number (e.g., 1)'
        required: true
        type: string

env:
  NODE_VERSION: '20.x'
  XCODE_VERSION: '15.0'  # Update to your required Xcode version

jobs:
  build-and-release:
    name: Build and Release iOS App
    runs-on: macos-14  # macOS runner required for iOS builds
    timeout-minutes: 60

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: |
          npm ci

      - name: ðŸ—ï¸ Build web app
        run: |
          npm run build

      - name: ðŸ“± Sync Capacitor iOS
        run: |
          npx cap sync ios

      - name: ðŸŽ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: ðŸ“ Update version and build number
        run: |
          # Extract version from tag or use input
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\/ios-v//')
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          
          BUILD_NUMBER="${{ github.event.inputs.build_number }}"
          if [ -z "$BUILD_NUMBER" ] && [ "${{ github.event_name }}" == "push" ]; then
            BUILD_NUMBER=$(date +%s)  # Use timestamp as build number
          fi
          
          # Update Info.plist version
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" ios/App/App/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" ios/App/App/Info.plist
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV

      - name: ðŸ” Install Apple Certificate
        if: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          # Decode certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $CERTIFICATE_PATH
          
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate
          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # Set partition list
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

      - name: ðŸ“± Install Provisioning Profile
        if: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        env:
          APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          PROVISIONING_PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/build_profile.mobileprovision
          echo "$APPLE_PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PROVISIONING_PROFILE_PATH"
          echo "$PROVISIONING_PROFILE_PATH"

      - name: ðŸ—ï¸ Build iOS Archive
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
        run: |
          xcodebuild clean archive \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -archivePath $RUNNER_TEMP/App.xcarchive \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="${{ secrets.PROVISIONING_PROFILE_NAME }}" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            CODE_SIGN_STYLE="Manual" \
            -allowProvisioningUpdates

      - name: ðŸ“¦ Export IPA
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/App.xcarchive \
            -exportPath $RUNNER_TEMP/export \
            -exportOptionsPlist ios/ExportOptions.plist

      - name: ðŸ“¤ Upload to TestFlight
        if: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        env:
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_APPLE_ID: ${{ secrets.APPLE_APPLE_ID }}
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file "$RUNNER_TEMP/export/App.ipa" \
            --username "$APPLE_APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD"

      - name: ðŸ“¦ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-${{ env.VERSION }}-${{ env.BUILD_NUMBER }}
          path: ${{ runner.temp }}/export/App.ipa
          retention-days: 30

      - name: ðŸ“‹ Release Notes
        run: |
          echo "## iOS Release ${{ env.VERSION }} (${{ env.BUILD_NUMBER }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± Version: ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”¢ Build: ${{ env.BUILD_NUMBER }}" >> $GITHUB_STEP_SUMMARY

